import { Injectable } from '@angular/core';
import { Ellipsoid, Cartesian3, Cartographic } from 'cesium';
import * as i0 from "@angular/core";
import * as i1 from "../cesium/cesium.service";
export class GeoUtilsService {
    constructor(cesiumService) {
        this.cesiumService = cesiumService;
    }
    static pointByLocationDistanceAndAzimuth(currentLocation, meterDistance, radianAzimuth, deprecated) {
        const distance = meterDistance / Ellipsoid.WGS84.maximumRadius;
        const cartographicLocation = currentLocation instanceof Cartesian3 ? Cartographic.fromCartesian(currentLocation) : currentLocation;
        const cartesianLocation = currentLocation instanceof Cartesian3
            ? currentLocation
            : Cartesian3.fromRadians(currentLocation.longitude, currentLocation.latitude, currentLocation.height);
        let resultPosition;
        let resultDistance;
        let counter = 0;
        let distanceFactorRangeMax = 0.1;
        let distanceFactorRangeMin = -0.1;
        while (counter === 0 ||
            (counter < 16 && Math.max(resultDistance, meterDistance) / Math.min(resultDistance, meterDistance) > 1.000001)) {
            const factor = distanceFactorRangeMin + (distanceFactorRangeMax - distanceFactorRangeMin) / 2;
            resultPosition = GeoUtilsService._pointByLocationDistanceAndAzimuth(cartographicLocation, distance * (1 + factor), radianAzimuth);
            resultDistance = this.distance(cartesianLocation, resultPosition);
            if (resultDistance > meterDistance) {
                distanceFactorRangeMax = distanceFactorRangeMin + (distanceFactorRangeMax - distanceFactorRangeMin) / 2;
            }
            else {
                distanceFactorRangeMin = distanceFactorRangeMin + (distanceFactorRangeMax - distanceFactorRangeMin) / 2;
            }
            counter++;
        }
        return resultPosition;
    }
    static _pointByLocationDistanceAndAzimuth(cartographicLocation, distance, radianAzimuth) {
        const curLat = cartographicLocation.latitude;
        const curLon = cartographicLocation.longitude;
        const destinationLat = Math.asin(Math.sin(curLat) * Math.cos(distance) + Math.cos(curLat) * Math.sin(distance) * Math.cos(radianAzimuth));
        let destinationLon = curLon +
            Math.atan2(Math.sin(radianAzimuth) * Math.sin(distance) * Math.cos(curLat), Math.cos(distance) - Math.sin(curLat) * Math.sin(destinationLat));
        destinationLon = ((destinationLon + 3 * Math.PI) % (2 * Math.PI)) - Math.PI;
        return Cartesian3.fromRadians(destinationLon, destinationLat);
    }
    static distance(pos0, pos1) {
        return Cartesian3.distance(pos0, pos1);
    }
    static getPositionsDelta(position0, position1) {
        return {
            x: position1.x - position0.x,
            y: position1.y - position0.y,
            z: position1.z - position0.z,
        };
    }
    static addDeltaToPosition(position, delta, updateReference = false) {
        if (updateReference) {
            position.x += delta.x;
            position.y += delta.y;
            position.z += delta.z;
            const cartographic = Cartographic.fromCartesian(position);
            cartographic.height = 0;
            const cartesian = Cartesian3.fromRadians(cartographic.longitude, cartographic.latitude, cartographic.height);
            position.x = cartesian.x;
            position.y = cartesian.y;
            position.z = cartesian.z;
            return position;
        }
        else {
            const cartesian = new Cartesian3(position.x + delta.x, position.y + delta.y, position.z + delta.z);
            const cartographic = Cartographic.fromCartesian(cartesian);
            cartographic.height = 0;
            return Cartesian3.fromRadians(cartographic.longitude, cartographic.latitude, cartographic.height);
        }
    }
    static middleCartesian3Point(position0, position1) {
        return new Cartesian3(position1.x - position0.x / 2, position1.y - position0.y / 2, position1.z - position0.z / 2);
    }
    screenPositionToCartesian3(screenPos) {
        const camera = this.cesiumService.getViewer().camera;
        return camera.pickEllipsoid(screenPos);
    }
}
GeoUtilsService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.3.0", ngImport: i0, type: GeoUtilsService, deps: [{ token: i1.CesiumService }], target: i0.ɵɵFactoryTarget.Injectable });
GeoUtilsService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "13.3.0", ngImport: i0, type: GeoUtilsService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.3.0", ngImport: i0, type: GeoUtilsService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.CesiumService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VvLXV0aWxzLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9zcmMvbGliL2FuZ3VsYXItY2VzaXVtL3NlcnZpY2VzL2dlby11dGlscy9nZW8tdXRpbHMuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLFlBQVksRUFBRSxNQUFNLFFBQVEsQ0FBQzs7O0FBSzdELE1BQU0sT0FBTyxlQUFlO0lBeUYxQixZQUFvQixhQUE0QjtRQUE1QixrQkFBYSxHQUFiLGFBQWEsQ0FBZTtJQUNoRCxDQUFDO0lBekZELE1BQU0sQ0FBQyxpQ0FBaUMsQ0FBQyxlQUFvQixFQUFFLGFBQXFCLEVBQUUsYUFBcUIsRUFBRSxVQUFXO1FBQ3RILE1BQU0sUUFBUSxHQUFHLGFBQWEsR0FBRyxTQUFTLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQztRQUMvRCxNQUFNLG9CQUFvQixHQUN4QixlQUFlLFlBQVksVUFBVSxDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxlQUFlLENBQUM7UUFDeEcsTUFBTSxpQkFBaUIsR0FDckIsZUFBZSxZQUFZLFVBQVU7WUFDbkMsQ0FBQyxDQUFDLGVBQWU7WUFDakIsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsZUFBZSxDQUFDLFNBQVMsRUFBRSxlQUFlLENBQUMsUUFBUSxFQUFFLGVBQWUsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUUxRyxJQUFJLGNBQWMsQ0FBQztRQUNuQixJQUFJLGNBQWMsQ0FBQztRQUNuQixJQUFJLE9BQU8sR0FBRyxDQUFDLENBQUM7UUFDaEIsSUFBSSxzQkFBc0IsR0FBRyxHQUFHLENBQUM7UUFDakMsSUFBSSxzQkFBc0IsR0FBRyxDQUFDLEdBQUcsQ0FBQztR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QUFDLFlBQVksQ0FBQyxTQUFTLEVBQUUsWUFBWSxDQUFDLFFBQVEsRUFBRSxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDbkc7SUFDSCxDQUFDO0lBRUQsTUFBTSxDQUFDLHFCQUFxQixDQUFDLFNBQXFCLEVBQUUsU0FBcUI7UUFDdkUsT0FBTyxJQUFJLFVBQVUsQ0FBQyxTQUFTLENBQUMsQ0FBQyxHQUFHLFNBQVMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLFNBQVMsQ0FBQyxDQUFDLEdBQUcsU0FBUyxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsU0FBUyxDQUFDLENBQUMsR0FBRyxTQUFTLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQ3JILENBQUM7SUFLRCwwQkFBMEIsQ0FBQyxTQUFtQztRQUM1RCxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLFNBQVMsRUFBRSxDQUFDLE1BQU0sQ0FBQztRQUNyRCxPQUFPLE1BQU0sQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDekMsQ0FBQzs7NEdBL0ZVLGVBQWU7Z0hBQWYsZUFBZTsyRkFBZixlQUFlO2tCQUQzQixVQUFVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBFbGxpcHNvaWQsIENhcnRlc2lhbjMsIENhcnRvZ3JhcGhpYyB9IGZyb20gJ2Nlc2l1bSc7XHJcbmltcG9ydCB7IENlc2l1bVNlcnZpY2UgfSBmcm9tICcuLi9jZXNpdW0vY2VzaXVtLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBWZWMzIH0gZnJvbSAnLi4vLi4vbW9kZWxzL3ZlYzMnO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgR2VvVXRpbHNTZXJ2aWNlIHtcclxuICBzdGF0aWMgcG9pbnRCeUxvY2F0aW9uRGlzdGFuY2VBbmRBemltdXRoKGN1cnJlbnRMb2NhdGlvbjogYW55LCBtZXRlckRpc3RhbmNlOiBudW1iZXIsIHJhZGlhbkF6aW11dGg6IG51bWJlciwgZGVwcmVjYXRlZD8pIHtcclxuICAgIGNvbnN0IGRpc3RhbmNlID0gbWV0ZXJEaXN0YW5jZSAvIEVsbGlwc29pZC5XR1M4NC5tYXhpbXVtUmFkaXVzO1xyXG4gICAgY29uc3QgY2FydG9ncmFwaGljTG9jYXRpb24gPVxyXG4gICAgICBjdXJyZW50TG9jYXRpb24gaW5zdGFuY2VvZiBDYXJ0ZXNpYW4zID8gQ2FydG9ncmFwaGljLmZyb21DYXJ0ZXNpYW4oY3VycmVudExvY2F0aW9uKSA6IGN1cnJlbnRMb2NhdGlvbjtcclxuICAgIGNvbnN0IGNhcnRlc2lhbkxvY2F0aW9uID1cclxuICAgICAgY3VycmVudExvY2F0aW9uIGluc3RhbmNlb2YgQ2FydGVzaWFuM1xyXG4gICAgICAgID8gY3VycmVudExvY2F0aW9uXHJcbiAgICAgICAgOiBDYXJ0ZXNpYW4zLmZyb21SYWRpYW5zKGN1cnJlbnRMb2NhdGlvbi5sb25naXR1ZGUsIGN1cnJlbnRMb2NhdGlvbi5sYXRpdHVkZSwgY3VycmVudExvY2F0aW9uLmhlaWdodCk7XHJcblxyXG4gICAgbGV0IHJlc3VsdFBvc2l0aW9uO1xyXG4gICAgbGV0IHJlc3VsdERpc3RhbmNlO1xyXG4gICAgbGV0IGNvdW50ZXIgPSAwO1xyXG4gICAgbGV0IGRpc3RhbmNlRmFjdG9yUmFuZ2VNYXggPSAwLjE7XHJcbiAgICBsZXQgZGlzdGFuY2VGYWN0b3JSYW5nZU1pbiA9IC0wLjE7XHJcbiAgICB3aGlsZSAoXHJcbiAgICAgIGNvdW50ZXIgPT09IDAgfHxcclxuICAgICAgKGNvdW50ZXIgPCAxNiAmJiBNYXRoLm1heChyZXN1bHREaXN0YW5jZSwgbWV0ZXJEaXN0YW5jZSkgLyBNYXRoLm1pbihyZXN1bHREaXN0YW5jZSwgbWV0ZXJEaXN0YW5jZSkgPiAxLjAwMDAwMSlcclxuICAgICAgKSB7XHJcbiAgICAgIGNvbnN0IGZhY3RvciA9IGRpc3RhbmNlRmFjdG9yUmFuZ2VNaW4gKyAoZGlzdGFuY2VGYWN0b3JSYW5nZU1heCAtIGRpc3RhbmNlRmFjdG9yUmFuZ2VNaW4pIC8gMjtcclxuICAgICAgcmVzdWx0UG9zaXRpb24gPSBHZW9VdGlsc1NlcnZpY2UuX3BvaW50QnlMb2NhdGlvbkRpc3RhbmNlQW5kQXppbXV0aChjYXJ0b2dyYXBoaWNMb2NhdGlvbiwgZGlzdGFuY2UgKiAoMSArIGZhY3RvciksIHJhZGlhbkF6aW11dGgpO1xyXG4gICAgICByZXN1bHREaXN0YW5jZSA9IHRoaXMuZGlzdGFuY2UoY2FydGVzaWFuTG9jYXRpb24sIHJlc3VsdFBvc2l0aW9uKTtcclxuXHJcbiAgICAgIGlmIChyZXN1bHREaXN0YW5jZSA+IG1ldGVyRGlzdGFuY2UpIHtcclxuICAgICAgICBkaXN0YW5jZUZhY3RvclJhbmdlTWF4ID0gZGlzdGFuY2VGYWN0b3JSYW5nZU1pbiArIChkaXN0YW5jZUZhY3RvclJhbmdlTWF4IC0gZGlzdGFuY2VGYWN0b3JSYW5nZU1pbikgLyAyO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGRpc3RhbmNlRmFjdG9yUmFuZ2VNaW4gPSBkaXN0YW5jZUZhY3RvclJhbmdlTWluICsgKGRpc3RhbmNlRmFjdG9yUmFuZ2VNYXggLSBkaXN0YW5jZUZhY3RvclJhbmdlTWluKSAvIDI7XHJcbiAgICAgIH1cclxuICAgICAgY291bnRlcisrO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiByZXN1bHRQb3NpdGlvbjtcclxuICB9XHJcblxyXG4gIHN0YXRpYyBfcG9pbnRCeUxvY2F0aW9uRGlzdGFuY2VBbmRBemltdXRoKGNhcnRvZ3JhcGhpY0xvY2F0aW9uOiBhbnksIGRpc3RhbmNlOiBudW1iZXIsIHJhZGlhbkF6aW11dGg6IG51bWJlcikge1xyXG4gICAgY29uc3QgY3VyTGF0ID0gY2FydG9ncmFwaGljTG9jYXRpb24ubGF0aXR1ZGU7XHJcbiAgICBjb25zdCBjdXJMb24gPSBjYXJ0b2dyYXBoaWNMb2NhdGlvbi5sb25naXR1ZGU7XHJcbiAgICBjb25zdCBkZXN0aW5hdGlvbkxhdCA9IE1hdGguYXNpbihcclxuICAgICAgTWF0aC5zaW4oY3VyTGF0KSAqIE1hdGguY29zKGRpc3RhbmNlKSArIE1hdGguY29zKGN1ckxhdCkgKiBNYXRoLnNpbihkaXN0YW5jZSkgKiBNYXRoLmNvcyhyYWRpYW5BemltdXRoKSxcclxuICAgICk7XHJcblxyXG4gICAgbGV0IGRlc3RpbmF0aW9uTG9uID1cclxuICAgICAgY3VyTG9uICtcclxuICAgICAgTWF0aC5hdGFuMihcclxuICAgICAgICBNYXRoLnNpbihyYWRpYW5BemltdXRoKSAqIE1hdGguc2luKGRpc3RhbmNlKSAqIE1hdGguY29zKGN1ckxhdCksXHJcbiAgICAgICAgTWF0aC5jb3MoZGlzdGFuY2UpIC0gTWF0aC5zaW4oY3VyTGF0KSAqIE1hdGguc2luKGRlc3RpbmF0aW9uTGF0KSxcclxuICAgICAgKTtcclxuXHJcbiAgICBkZXN0aW5hdGlvbkxvbiA9ICgoZGVzdGluYXRpb25Mb24gKyAzICogTWF0aC5QSSkgJSAoMiAqIE1hdGguUEkpKSAtIE1hdGguUEk7XHJcblxyXG4gICAgcmV0dXJuIENhcnRlc2lhbjMuZnJvbVJhZGlhbnMoZGVzdGluYXRpb25Mb24sIGRlc3RpbmF0aW9uTGF0KTtcclxuICB9XHJcblxyXG4gIHN0YXRpYyBkaXN0YW5jZShwb3MwOiBDYXJ0ZXNpYW4zLCBwb3MxOiBDYXJ0ZXNpYW4zKTogbnVtYmVyIHtcclxuICAgIHJldHVybiBDYXJ0ZXNpYW4zLmRpc3RhbmNlKHBvczAsIHBvczEpO1xyXG4gIH1cclxuXHJcbiAgc3RhdGljIGdldFBvc2l0aW9uc0RlbHRhKHBvc2l0aW9uMDogQ2FydGVzaWFuMywgcG9zaXRpb24xOiBDYXJ0ZXNpYW4zKTogVmVjMyB7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICB4OiBwb3NpdGlvbjEueCAtIHBvc2l0aW9uMC54LFxyXG4gICAgICB5OiBwb3NpdGlvbjEueSAtIHBvc2l0aW9uMC55LFxyXG4gICAgICB6OiBwb3NpdGlvbjEueiAtIHBvc2l0aW9uMC56LFxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIHN0YXRpYyBhZGREZWx0YVRvUG9zaXRpb24ocG9zaXRpb246IENhcnRlc2lhbjMsIGRlbHRhOiBWZWMzLCB1cGRhdGVSZWZlcmVuY2UgPSBmYWxzZSk6IENhcnRlc2lhbjMge1xyXG4gICAgaWYgKHVwZGF0ZVJlZmVyZW5jZSkge1xyXG4gICAgICBwb3NpdGlvbi54ICs9IGRlbHRhLng7XHJcbiAgICAgIHBvc2l0aW9uLnkgKz0gZGVsdGEueTtcclxuICAgICAgcG9zaXRpb24ueiArPSBkZWx0YS56O1xyXG4gICAgICBjb25zdCBjYXJ0b2dyYXBoaWMgPSBDYXJ0b2dyYXBoaWMuZnJvbUNhcnRlc2lhbihwb3NpdGlvbik7XHJcbiAgICAgIGNhcnRvZ3JhcGhpYy5oZWlnaHQgPSAwO1xyXG4gICAgICBjb25zdCBjYXJ0ZXNpYW4gPSBDYXJ0ZXNpYW4zLmZyb21SYWRpYW5zKGNhcnRvZ3JhcGhpYy5sb25naXR1ZGUsIGNhcnRvZ3JhcGhpYy5sYXRpdHVkZSwgY2FydG9ncmFwaGljLmhlaWdodCk7XHJcbiAgICAgIHBvc2l0aW9uLnggPSBjYXJ0ZXNpYW4ueDtcclxuICAgICAgcG9zaXRpb24ueSA9IGNhcnRlc2lhbi55O1xyXG4gICAgICBwb3NpdGlvbi56ID0gY2FydGVzaWFuLno7XHJcbiAgICAgIHJldHVybiBwb3NpdGlvbjtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGNvbnN0IGNhcnRlc2lhbiA9IG5ldyBDYXJ0ZXNpYW4zKHBvc2l0aW9uLnggKyBkZWx0YS54LCBwb3NpdGlvbi55ICsgZGVsdGEueSwgcG9zaXRpb24ueiArIGRlbHRhLnopO1xyXG4gICAgICBjb25zdCBjYXJ0b2dyYXBoaWMgPSBDYXJ0b2dyYXBoaWMuZnJvbUNhcnRlc2lhbihjYXJ0ZXNpYW4pO1xyXG4gICAgICBjYXJ0b2dyYXBoaWMuaGVpZ2h0ID0gMDtcclxuICAgICAgcmV0dXJuIENhcnRlc2lhbjMuZnJvbVJhZGlhbnMoY2FydG9ncmFwaGljLmxvbmdpdHVkZSwgY2FydG9ncmFwaGljLmxhdGl0dWRlLCBjYXJ0b2dyYXBoaWMuaGVpZ2h0KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHN0YXRpYyBtaWRkbGVDYXJ0ZXNpYW4zUG9pbnQocG9zaXRpb24wOiBDYXJ0ZXNpYW4zLCBwb3NpdGlvbjE6IENhcnRlc2lhbjMpIHtcclxuICAgIHJldHVybiBuZXcgQ2FydGVzaWFuMyhwb3NpdGlvbjEueCAtIHBvc2l0aW9uMC54IC8gMiwgcG9zaXRpb24xLnkgLSBwb3NpdGlvbjAueSAvIDIsIHBvc2l0aW9uMS56IC0gcG9zaXRpb24wLnogLyAyKTtcclxuICB9XHJcblxyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgY2VzaXVtU2VydmljZTogQ2VzaXVtU2VydmljZSkge1xyXG4gIH1cclxuXHJcbiAgc2NyZWVuUG9zaXRpb25Ub0NhcnRlc2lhbjMoc2NyZWVuUG9zOiB7IHg6IG51bWJlcjsgeTogbnVtYmVyIH0pIHtcclxuICAgIGNvbnN0IGNhbWVyYSA9IHRoaXMuY2VzaXVtU2VydmljZS5nZXRWaWV3ZXIoKS5jYW1lcmE7XHJcbiAgICByZXR1cm4gY2FtZXJhLnBpY2tFbGxpcHNvaWQoc2NyZWVuUG9zKTtcclxuICB9XHJcbn1cclxuIl19